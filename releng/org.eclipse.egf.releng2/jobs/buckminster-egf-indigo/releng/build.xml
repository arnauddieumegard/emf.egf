<?xml version="1.0" encoding="UTF-8"?>
<!--
This file was generated by Eclipse EGF
-->
<project name="project" default="all">
    <!--Property file containing overrides for the default properties -->
    <property environment="env" />
    <property file="build.properties" />

	<property name="relengDir" value="${basedir}"/>

    <!-- if we are not running in Hudson, we some up with a reasonable default -->
    <condition property="build.root" value="${env.WORKSPACE}" else="${relengDir}/../workspace">
        <isset property="env.WORKSPACE" />
    </condition>

    <!--Default properties intended to be overridden by entries in the above property file. -->
    <property name="tools" location="${build.root}/tools" />
    <property name="result" location="${build.root}/result" />
	
    <property name="workspace" location="${result}/workspace" />
    <property name="publish" location="${result}/publish" />
    <property name="buckminster.output.root" location="${result}/output" />
    <property name="buckminster.temp.root" location="${result}/temp" />
    <property name="eclipse.staging.area" location="${result}/signing" />
    <!-- This macro executes the default application of an eclipse installation that resides
         in the folder ${buildtools}/@app
      -->
    <macrodef name="eclipse.launch">
        <attribute name="app" />
        <element name="args" optional="true" />
        <sequential>
            <!-- We assume that the eclipse installation is beneath ${buildtools} -->
            <property name="@{app}.deploy.dir" value="${tools}/@{app}" />

            <!-- Find the Eclipse launcher and assing its location to the @{app}.launcher property -->
            <pathconvert property="@{app}.launcher">
                <first count="1">
                    <sort>
                        <fileset dir="${@{app}.deploy.dir}/plugins" includes="**/org.eclipse.equinox.launcher_*.jar" />
                        <reverse xmlns="antlib:org.apache.tools.ant.types.resources.comparators">
                            <date />
                        </reverse>
                    </sort>
                </first>
            </pathconvert>

            <!-- Launch the eclipse application -->
            <java fork="true" jar="${@{app}.launcher}" dir="${@{app}.deploy.dir}" failonerror="true">
                    <jvmarg value="-Xmx1024m"/>
                    <jvmarg value="-XX:MaxPermSize=256m"/>

                <args />
            </java>
        </sequential>
    </macrodef>
    <target name="install.director">
        <available file="${tools}/director/director" property="director.exists" />
        <antcall target="do.install.director" />
    </target>
    
    <target name="do.install.director" unless="director.exists">
        <echo message="Fetching headless director application" />
        <tempfile destdir="${java.io.tmpdir}" prefix="director-" suffix=".zip" property="director.zip" deleteonexit="true" />
        <get src="${director.url}" dest="${director.zip}" />
        <mkdir dir="${tools}" />
        <unzip src="${director.zip}" dest="${tools}" />
        <delete file="${director.zip}" />
    </target>
    <target name="install.buckminster">
        <available file="${tools}/buckminster/buckminster" property="buckminster.exists" />
        <antcall target="do.install.buckminster" />
	</target>
	
    <target name="do.install.buckminster" unless="buckminster.exists" depends="install.director">
        <echo message="Configuring headless buckminster with needed features" />
        <echo message="Headless site: ${bm.headless.site}" />
        <echo message="External site: ${bm.external.site}" />
        <eclipse.launch app="director">
            <args>
                <jvmarg value="-Declipse.p2.mirrors=false" />
                <arg value="-r" />
                <arg value="${bm.headless.site}" />
                <arg value="-r" />
                <arg value="${bm.external.site}" />
                <arg value="-r" />
                <arg value="${polarion.site}" />
                <arg value="-d" />
                <arg value="${tools}/buckminster" />
                <arg value="-p" />
                <arg value="Buckminster" />
                <arg value="-i" />
                <arg value="org.eclipse.buckminster.cmdline.product" />
                <arg value="-i" />
                <arg value="org.eclipse.buckminster.core.headless.feature.feature.group" />
                <arg value="-i" />
                <arg value="org.eclipse.buckminster.pde.headless.feature.feature.group" />
                <arg value="-i" />
                <arg value="org.eclipse.buckminster.cvs.headless.feature.feature.group" />
                <arg value="-i" />
                <arg value="org.eclipse.buckminster.subversive.headless.feature.feature.group" />
                <arg value="-i" />
                <arg value="org.eclipse.buckminster.emma.headless.feature.feature.group" />
            </args>
        </eclipse.launch>
    </target>
    <target name="install.egf">
        <available file="${tools}/egf/eclipse.ini" property="egf.exists" />
        <antcall target="do.install.egf" />
	</target>

	<target name="do.install.egf" unless="egf.exists" depends="install.director">
        <echo message="Configuring EGF with needed features" />
        <echo message="EGF site: ${egf.site}" />
        <echo message="EGF eclipse site: ${egf.eclipse.site}" />
        <eclipse.launch app="director">
            <args>
                <jvmarg value="-Declipse.p2.mirrors=false" />
                <arg value="-r" />
                <arg value="${egf.site}" />
                <arg value="-r" />
                <arg value="${egf.eclipse.site}" />
                <arg value="-d" />
                <arg value="${tools}/egf" />
                <arg value="-p" />
                <arg value="EGF" />
                <arg value="-i" />
                <arg value="org.eclipse.platform.ide" />
                <arg value="-i" />
                <arg value="org.eclipse.egf.feature.group" />
                <arg value="-i" />
                <arg value="org.eclipse.egf.portfolio.feature.group" />
                <arg value="-i" />
                <arg value="org.eclipse.egf.portfolio.emf.feature.group" />
                <arg value="-i" />
                <arg value="org.eclipse.egf.portfolio.genchain.feature.group" />
            </args>
        </eclipse.launch>
    </target>
    <macrodef name="buckminster">
        <attribute name="command" />
        <attribute name="workspace" default="${workspace}" />
        <element name="globargs" optional="true" />
        <element name="cmdargs" optional="true" />
        <sequential>
            <eclipse.launch app="buckminster">
                <args>
                    <jvmarg value="-Dbugfix.288796=true"/>
                    <arg value="-data" />
                    <arg value="@{workspace}" />
                    <arg value="--loglevel" />
                    <arg value="${buckminster.loglevel}" />
                    <arg value="--displaystacktrace" />
                    <globargs />
                    <arg value="@{command}" />
                    <arg value="-P" />
                    <arg value="${properties.tmp}" />
                    <cmdargs />
                </args>
            </eclipse.launch>
        </sequential>
    </macrodef>
	<macrodef name="egf">
        <attribute name="workspace" default="${workspace}" />
        <element name="activities" />
        <element name="globargs" optional="true" />
        <element name="cmdargs" optional="true" />
        <sequential>
            <eclipse.launch app="egf">
                <args>
                    <arg value="-application" />
                    <arg value="org.eclipse.egf.application.activity" />
                    <arg value="-consoleLog" />
                    <arg value="-data" />
                    <arg value="@{workspace}" />
                    <globargs />
                    <arg value="-activities" />
                    <activities />
                    <cmdargs />
                </args>
            </eclipse.launch>
        </sequential>
    </macrodef>
	<macrodef name="anteclipse">
        <attribute name="workspace" default="${workspace}" />
        <attribute name="buildfile" default="${relengDir}/build.xml" />
        <attribute name="target" />
        <element name="globargs" optional="true" />
        <sequential>
            <eclipse.launch app="egf">
                <args>
					<arg value="-application" />
					<arg value="org.eclipse.ant.core.antRunner" />
					<arg value="-consoleLog" />
					<arg value="-data" />
					<arg value="@{workspace}" />
                    <globargs />
					<arg value="-buildfile" />
					<arg value="@{buildfile}" />
					<arg value="@{target}" />
                </args>
            </eclipse.launch>
        </sequential>
    </macrodef>
    <target name="clean.result">
        <delete dir="${result}" failonerror="true" quiet="true" />
    </target>

    <target name="clean.workspace">
        <delete dir="${workspace}" failonerror="true" quiet="true" />
    </target>

    <target name="clean.tools">
        <delete dir="${tools}" failonerror="true" quiet="true" />
    </target>

    <target name="clean.all">
		<antcall target="clean.workspace" />
		<antcall target="clean.result" />
		<antcall target="clean.tools" />
    </target>
	<target name="init" depends="init.build.properties" />	

    <target name="init.build.properties">
        <!-- Echo relevant properties to a temporary file so that Buckminster can read them -->
        <tempfile destdir="${java.io.tmpdir}" prefix="build-" suffix=".properties" deleteonexit="true" property="properties.tmp" />
        <echoproperties destfile="${properties.tmp}">
            <!-- We don't want these. basedir in particular will cause problems if passed explicitly -->
            <propertyset negate="true">
                <propertyref name="basedir" />
                <propertyref name="eclipse.home" />
                <propertyref name="properties.tmp" />
                <propertyref name="line.separator" />
                <propertyref name="path.separator" />
                <propertyref prefix="ant." />
                <propertyref prefix="file." />
                <propertyref prefix="java." />
                <propertyref prefix="sun." />
                <propertyref prefix="user." />
            </propertyset>
        </echoproperties>
    </target>
	
	<target name="all" depends="init,step1,step2,step3,step4,step5,step6,step7,step8,step9,step10,step11,step12,step13,step14,step15,step16,step17,step18,step19,step20,step21,step22" />
	<target name="step1" >
		<antcall target="clean.result" />
	</target>
	<target name="step6" >
		<antcall target="clean.result" />
	</target>
    <target name="step2" depends="init,install.buckminster">
        <echo message="Importing projects into workspace ${workspace} and binaries into target platform" />

		<echo message="install JRE ${env.JAVA_HOME}" />
    	<buckminster command="installJRE">
            <cmdargs>
                <arg value="--location" />
                <arg value="${env.JAVA_HOME}" />
            </cmdargs>
        </buckminster>


		<echo message="import target platform" />
        <buckminster command="importtargetdefinition">
            <cmdargs>
                <arg value="--active" />
                <arg value="${relengDir}/buckminster_step2/build.target" />
            </cmdargs>
        </buckminster>
		<echo message="provision : import projects in workspace" />
        <buckminster command="import">
            <!-- Uncomment to debug <globargs><jvmarg value="-agentlib:jdwp=transport=dt_socket,address=8000,server=y,suspend=y"/></globargs> -->
            <cmdargs>
                <arg value="-P" />
                <arg value="${relengDir}/build.properties" />
                <arg value="${relengDir}/buckminster_step2/build.mspec" />
            </cmdargs>
        </buckminster>


        <echo message="Invoking all eclipse builders on workspace ${workspace}" />
        <buckminster command="build" >
            <cmdargs>
                <arg value="--clean" />
                <arg value="--thorough" />
            </cmdargs>
		</buckminster>
    </target>

    <target name="step7" depends="init,install.buckminster">
        <echo message="Importing projects into workspace ${workspace} and binaries into target platform" />

		<echo message="install JRE ${env.JAVA_HOME}" />
    	<buckminster command="installJRE">
            <cmdargs>
                <arg value="--location" />
                <arg value="${env.JAVA_HOME}" />
            </cmdargs>
        </buckminster>


		<echo message="import target platform" />
        <buckminster command="importtargetdefinition">
            <cmdargs>
                <arg value="--active" />
                <arg value="${relengDir}/buckminster_step7/build.target" />
            </cmdargs>
        </buckminster>
		<echo message="provision : import projects in workspace" />
        <buckminster command="import">
            <!-- Uncomment to debug <globargs><jvmarg value="-agentlib:jdwp=transport=dt_socket,address=8000,server=y,suspend=y"/></globargs> -->
            <cmdargs>
                <arg value="-P" />
                <arg value="${relengDir}/build.properties" />
                <arg value="${relengDir}/buckminster_step7/build.mspec" />
            </cmdargs>
        </buckminster>


        <echo message="No builders invocation specified" />
    </target>

    <target name="step8" depends="init,install.buckminster">
        <echo message="Importing projects into workspace ${workspace} and binaries into target platform" />

		<echo message="install JRE ${env.JAVA_HOME}" />
    	<buckminster command="installJRE">
            <cmdargs>
                <arg value="--location" />
                <arg value="${env.JAVA_HOME}" />
            </cmdargs>
        </buckminster>


		<echo message="import target platform" />
        <buckminster command="importtargetdefinition">
            <cmdargs>
                <arg value="--active" />
                <arg value="${relengDir}/buckminster_step8/build.target" />
            </cmdargs>
        </buckminster>
		<echo message="provision : import projects in workspace" />
        <buckminster command="import">
            <!-- Uncomment to debug <globargs><jvmarg value="-agentlib:jdwp=transport=dt_socket,address=8000,server=y,suspend=y"/></globargs> -->
            <cmdargs>
                <arg value="-P" />
                <arg value="${relengDir}/build.properties" />
                <arg value="${relengDir}/buckminster_step8/build.mspec" />
            </cmdargs>
        </buckminster>


        <echo message="No builders invocation specified" />
    </target>

    <target name="step10" depends="init,install.buckminster">
        <echo message="Importing projects into workspace ${workspace} and binaries into target platform" />

		<echo message="install JRE ${env.JAVA_HOME}" />
    	<buckminster command="installJRE">
            <cmdargs>
                <arg value="--location" />
                <arg value="${env.JAVA_HOME}" />
            </cmdargs>
        </buckminster>


		<echo message="import target platform" />
        <buckminster command="importtargetdefinition">
            <cmdargs>
                <arg value="--active" />
                <arg value="${relengDir}/buckminster_step10/build.target" />
            </cmdargs>
        </buckminster>
		<echo message="provision : import projects in workspace" />
        <buckminster command="import">
            <!-- Uncomment to debug <globargs><jvmarg value="-agentlib:jdwp=transport=dt_socket,address=8000,server=y,suspend=y"/></globargs> -->
            <cmdargs>
                <arg value="-P" />
                <arg value="${relengDir}/build.properties" />
                <arg value="${relengDir}/buckminster_step10/build.mspec" />
            </cmdargs>
        </buckminster>


        <echo message="Invoking all eclipse builders on workspace ${workspace}" />
        <buckminster command="build" >
            <cmdargs>
                <arg value="--clean" />
                <arg value="--thorough" />
            </cmdargs>
		</buckminster>
    </target>

	<target name="step3" depends="init,install.buckminster" >

		
		<echo message="Generate Site"/>
		<buckminster command="perform">
			<globargs>
				<arg value="-Dsite.include.top=true"/>
				<arg value="-Dsite.signing=false"/>				
				<arg value="-Dcbi.include.source=true"/>				
			</globargs>
			<cmdargs>
				<arg value="org.eclipse.egf:eclipse.feature#site.p2" />
			</cmdargs>
		</buckminster>

		<echo message="Publish site"/>
		<mkdir dir="${publish}/org.eclipse.egf/site.p2/"/>
		<copy todir="${publish}/org.eclipse.egf/site.p2/">
			<fileset dir="${result}/output">
				<include name="org.eclipse.egf*/site.p2/*"/>
				<include name="org.eclipse.egf*/site.p2/**"/>
			</fileset>
			<filtermapper>
				<replaceregex pattern=".*site\.p2" replace="" />
			</filtermapper>
		</copy>

		<echo message="Publish dropins"/>
		<condition property="site.src" value="site.signed" else="site">
			<istrue value="${site.signing}" />
		</condition>

		<copy todir="${publish}/org.eclipse.egf/dropins/org.eclipse.egf/eclipse/">
			<fileset dir="${result}/output">
				<include name="org.eclipse.egf*/${site.src}/plugins/*.jar"/>
				<include name="org.eclipse.egf*/${site.src}/features/*.jar"/>
			</fileset>
			<filtermapper>
				<replaceregex pattern=".*_.*-eclipse\.feature.${site.src}.plugins" replace="plugins" />
				<replaceregex pattern=".*_.*-eclipse\.feature.${site.src}.features" replace="features" />
			</filtermapper>
		</copy>

		<buckminster command="perform">
			<globargs>
				<arg value="-DsiteDir=${publish}/org.eclipse.egf/dropins/org.eclipse.egf/eclipse/" />
			</globargs>
			<cmdargs>			
				<arg value="step2:buckminster#convertSiteToRuntime" />
			</cmdargs>
		</buckminster>
		
		<pathconvert property="featurefilestep3">
			<first count="1">
				<fileset dir="${result}/output" includes="org.eclipse.egf*eclipse.feature/temp/feature.xml" />
			</first>
		</pathconvert>
		<loadfile property="featureversionstep3" srcFile="${featurefilestep3}">
			<filterchain>
				<striplinebreaks/>
				<replaceregex
					pattern="^.*&lt;feature[^&gt;]*version=&quot;([^&quot;]*)&quot;.*$"
					replace="\1"/>
			</filterchain>
		</loadfile>

		<touch file="${publish}/org.eclipse.egf/dropins/org.eclipse.egf/org.eclipse.egf_version_${featureversionstep3}" />
	</target>

	<target name="step14" depends="init,install.buckminster" >

		
		<echo message="Generate Site"/>
		<buckminster command="perform">
			<globargs>
				<arg value="-Dsite.include.top=true"/>
				<arg value="-Dsite.signing=true"/>				
				<arg value="-Dcbi.include.source=true"/>				
			</globargs>
			<cmdargs>
				<arg value="org.eclipse.egf.sdk:eclipse.feature#site.p2" />
			</cmdargs>
		</buckminster>

		<echo message="Publish site"/>
		<mkdir dir="${publish}/org.eclipse.egf.sdk/site.p2/"/>
		<copy todir="${publish}/org.eclipse.egf.sdk/site.p2/">
			<fileset dir="${result}/output">
				<include name="org.eclipse.egf.sdk*/site.p2/*"/>
				<include name="org.eclipse.egf.sdk*/site.p2/**"/>
			</fileset>
			<filtermapper>
				<replaceregex pattern=".*site\.p2" replace="" />
			</filtermapper>
		</copy>

		<echo message="Publish dropins"/>
		<condition property="site.src" value="site.signed" else="site">
			<istrue value="${site.signing}" />
		</condition>

		<copy todir="${publish}/org.eclipse.egf.sdk/dropins/org.eclipse.egf.sdk/eclipse/">
			<fileset dir="${result}/output">
				<include name="org.eclipse.egf.sdk*/${site.src}/plugins/*.jar"/>
				<include name="org.eclipse.egf.sdk*/${site.src}/features/*.jar"/>
			</fileset>
			<filtermapper>
				<replaceregex pattern=".*_.*-eclipse\.feature.${site.src}.plugins" replace="plugins" />
				<replaceregex pattern=".*_.*-eclipse\.feature.${site.src}.features" replace="features" />
			</filtermapper>
		</copy>

		<buckminster command="perform">
			<globargs>
				<arg value="-DsiteDir=${publish}/org.eclipse.egf.sdk/dropins/org.eclipse.egf.sdk/eclipse/" />
			</globargs>
			<cmdargs>			
				<arg value="step7:buckminster#convertSiteToRuntime" />
			</cmdargs>
		</buckminster>
		
		<pathconvert property="featurefilestep14">
			<first count="1">
				<fileset dir="${result}/output" includes="org.eclipse.egf.sdk*eclipse.feature/temp/feature.xml" />
			</first>
		</pathconvert>
		<loadfile property="featureversionstep14" srcFile="${featurefilestep14}">
			<filterchain>
				<striplinebreaks/>
				<replaceregex
					pattern="^.*&lt;feature[^&gt;]*version=&quot;([^&quot;]*)&quot;.*$"
					replace="\1"/>
			</filterchain>
		</loadfile>

		<touch file="${publish}/org.eclipse.egf.sdk/dropins/org.eclipse.egf.sdk/org.eclipse.egf.sdk_version_${featureversionstep14}" />
	</target>

	<target name="step16" depends="init,install.buckminster" >

		
		<echo message="Generate Site"/>
		<buckminster command="perform">
			<globargs>
				<arg value="-Dsite.include.top=true"/>
				<arg value="-Dsite.signing=true"/>				
				<arg value="-Dcbi.include.source=true"/>				
			</globargs>
			<cmdargs>
				<arg value="org.eclipse.egf.portfolio.acceleo3:eclipse.feature#site.p2" />
			</cmdargs>
		</buckminster>

		<echo message="Publish site"/>
		<mkdir dir="${publish}/org.eclipse.egf.portfolio.acceleo3/site.p2/"/>
		<copy todir="${publish}/org.eclipse.egf.portfolio.acceleo3/site.p2/">
			<fileset dir="${result}/output">
				<include name="org.eclipse.egf.portfolio.acceleo3*/site.p2/*"/>
				<include name="org.eclipse.egf.portfolio.acceleo3*/site.p2/**"/>
			</fileset>
			<filtermapper>
				<replaceregex pattern=".*site\.p2" replace="" />
			</filtermapper>
		</copy>

		<echo message="Publish dropins"/>
		<condition property="site.src" value="site.signed" else="site">
			<istrue value="${site.signing}" />
		</condition>

		<copy todir="${publish}/org.eclipse.egf.portfolio.acceleo3/dropins/org.eclipse.egf.portfolio.acceleo3/eclipse/">
			<fileset dir="${result}/output">
				<include name="org.eclipse.egf.portfolio.acceleo3*/${site.src}/plugins/*.jar"/>
				<include name="org.eclipse.egf.portfolio.acceleo3*/${site.src}/features/*.jar"/>
			</fileset>
			<filtermapper>
				<replaceregex pattern=".*_.*-eclipse\.feature.${site.src}.plugins" replace="plugins" />
				<replaceregex pattern=".*_.*-eclipse\.feature.${site.src}.features" replace="features" />
			</filtermapper>
		</copy>

		<buckminster command="perform">
			<globargs>
				<arg value="-DsiteDir=${publish}/org.eclipse.egf.portfolio.acceleo3/dropins/org.eclipse.egf.portfolio.acceleo3/eclipse/" />
			</globargs>
			<cmdargs>			
				<arg value="step7:buckminster#convertSiteToRuntime" />
			</cmdargs>
		</buckminster>
		
		<pathconvert property="featurefilestep16">
			<first count="1">
				<fileset dir="${result}/output" includes="org.eclipse.egf.portfolio.acceleo3*eclipse.feature/temp/feature.xml" />
			</first>
		</pathconvert>
		<loadfile property="featureversionstep16" srcFile="${featurefilestep16}">
			<filterchain>
				<striplinebreaks/>
				<replaceregex
					pattern="^.*&lt;feature[^&gt;]*version=&quot;([^&quot;]*)&quot;.*$"
					replace="\1"/>
			</filterchain>
		</loadfile>

		<touch file="${publish}/org.eclipse.egf.portfolio.acceleo3/dropins/org.eclipse.egf.portfolio.acceleo3/org.eclipse.egf.portfolio.acceleo3_version_${featureversionstep16}" />
	</target>

	<target name="step18" depends="init,install.buckminster" >

		
		<echo message="Generate Site"/>
		<buckminster command="perform">
			<globargs>
				<arg value="-Dsite.include.top=true"/>
				<arg value="-Dsite.signing=true"/>				
				<arg value="-Dcbi.include.source=true"/>				
			</globargs>
			<cmdargs>
				<arg value="org.eclipse.egf.portfolio.atl:eclipse.feature#site.p2" />
			</cmdargs>
		</buckminster>

		<echo message="Publish site"/>
		<mkdir dir="${publish}/org.eclipse.egf.portfolio.atl/site.p2/"/>
		<copy todir="${publish}/org.eclipse.egf.portfolio.atl/site.p2/">
			<fileset dir="${result}/output">
				<include name="org.eclipse.egf.portfolio.atl*/site.p2/*"/>
				<include name="org.eclipse.egf.portfolio.atl*/site.p2/**"/>
			</fileset>
			<filtermapper>
				<replaceregex pattern=".*site\.p2" replace="" />
			</filtermapper>
		</copy>

		<echo message="Publish dropins"/>
		<condition property="site.src" value="site.signed" else="site">
			<istrue value="${site.signing}" />
		</condition>

		<copy todir="${publish}/org.eclipse.egf.portfolio.atl/dropins/org.eclipse.egf.portfolio.atl/eclipse/">
			<fileset dir="${result}/output">
				<include name="org.eclipse.egf.portfolio.atl*/${site.src}/plugins/*.jar"/>
				<include name="org.eclipse.egf.portfolio.atl*/${site.src}/features/*.jar"/>
			</fileset>
			<filtermapper>
				<replaceregex pattern=".*_.*-eclipse\.feature.${site.src}.plugins" replace="plugins" />
				<replaceregex pattern=".*_.*-eclipse\.feature.${site.src}.features" replace="features" />
			</filtermapper>
		</copy>

		<buckminster command="perform">
			<globargs>
				<arg value="-DsiteDir=${publish}/org.eclipse.egf.portfolio.atl/dropins/org.eclipse.egf.portfolio.atl/eclipse/" />
			</globargs>
			<cmdargs>			
				<arg value="step7:buckminster#convertSiteToRuntime" />
			</cmdargs>
		</buckminster>
		
		<pathconvert property="featurefilestep18">
			<first count="1">
				<fileset dir="${result}/output" includes="org.eclipse.egf.portfolio.atl*eclipse.feature/temp/feature.xml" />
			</first>
		</pathconvert>
		<loadfile property="featureversionstep18" srcFile="${featurefilestep18}">
			<filterchain>
				<striplinebreaks/>
				<replaceregex
					pattern="^.*&lt;feature[^&gt;]*version=&quot;([^&quot;]*)&quot;.*$"
					replace="\1"/>
			</filterchain>
		</loadfile>

		<touch file="${publish}/org.eclipse.egf.portfolio.atl/dropins/org.eclipse.egf.portfolio.atl/org.eclipse.egf.portfolio.atl_version_${featureversionstep18}" />
	</target>

	<target name="step19" depends="init,install.buckminster" >

		
		<echo message="Generate Site"/>
		<buckminster command="perform">
			<globargs>
				<arg value="-Dsite.include.top=true"/>
				<arg value="-Dsite.signing=true"/>				
				<arg value="-Dcbi.include.source=true"/>				
			</globargs>
			<cmdargs>
				<arg value="org.eclipse.egf.portfolio.genchain.ecoretools:eclipse.feature#site.p2" />
			</cmdargs>
		</buckminster>

		<echo message="Publish site"/>
		<mkdir dir="${publish}/org.eclipse.egf.portfolio.genchain.ecoretools/site.p2/"/>
		<copy todir="${publish}/org.eclipse.egf.portfolio.genchain.ecoretools/site.p2/">
			<fileset dir="${result}/output">
				<include name="org.eclipse.egf.portfolio.genchain.ecoretools*/site.p2/*"/>
				<include name="org.eclipse.egf.portfolio.genchain.ecoretools*/site.p2/**"/>
			</fileset>
			<filtermapper>
				<replaceregex pattern=".*site\.p2" replace="" />
			</filtermapper>
		</copy>

		<echo message="Publish dropins"/>
		<condition property="site.src" value="site.signed" else="site">
			<istrue value="${site.signing}" />
		</condition>

		<copy todir="${publish}/org.eclipse.egf.portfolio.genchain.ecoretools/dropins/org.eclipse.egf.portfolio.genchain.ecoretools/eclipse/">
			<fileset dir="${result}/output">
				<include name="org.eclipse.egf.portfolio.genchain.ecoretools*/${site.src}/plugins/*.jar"/>
				<include name="org.eclipse.egf.portfolio.genchain.ecoretools*/${site.src}/features/*.jar"/>
			</fileset>
			<filtermapper>
				<replaceregex pattern=".*_.*-eclipse\.feature.${site.src}.plugins" replace="plugins" />
				<replaceregex pattern=".*_.*-eclipse\.feature.${site.src}.features" replace="features" />
			</filtermapper>
		</copy>

		<buckminster command="perform">
			<globargs>
				<arg value="-DsiteDir=${publish}/org.eclipse.egf.portfolio.genchain.ecoretools/dropins/org.eclipse.egf.portfolio.genchain.ecoretools/eclipse/" />
			</globargs>
			<cmdargs>			
				<arg value="step7:buckminster#convertSiteToRuntime" />
			</cmdargs>
		</buckminster>
		
		<pathconvert property="featurefilestep19">
			<first count="1">
				<fileset dir="${result}/output" includes="org.eclipse.egf.portfolio.genchain.ecoretools*eclipse.feature/temp/feature.xml" />
			</first>
		</pathconvert>
		<loadfile property="featureversionstep19" srcFile="${featurefilestep19}">
			<filterchain>
				<striplinebreaks/>
				<replaceregex
					pattern="^.*&lt;feature[^&gt;]*version=&quot;([^&quot;]*)&quot;.*$"
					replace="\1"/>
			</filterchain>
		</loadfile>

		<touch file="${publish}/org.eclipse.egf.portfolio.genchain.ecoretools/dropins/org.eclipse.egf.portfolio.genchain.ecoretools/org.eclipse.egf.portfolio.genchain.ecoretools_version_${featureversionstep19}" />
	</target>

	<target name="step11" depends="init,install.buckminster">
	  <echo message="Running Junit tests " />
      <buckminster command="junit">
        <cmdargs>
          <arg value="-l" />
          <arg value="org.eclipse.egf.core.test/EGF_Core_Tests.launch" />
          <arg value="-o" />
          <arg value="${result}/testReportstep11.xml" />
          <arg value="--terseXML" />
          <arg value="--flatXML"/>
        </cmdargs>
      </buckminster>
	</target>

	<target name="step12" depends="init,install.buckminster">
	  <echo message="Running Junit tests " />
      <buckminster command="junit">
        <cmdargs>
          <arg value="-l" />
          <arg value="org.eclipse.egf.portfolio.task.ant.test/Ant_Tests.launch" />
          <arg value="-o" />
          <arg value="${result}/testReportstep12.xml" />
          <arg value="--terseXML" />
          <arg value="--flatXML"/>
        </cmdargs>
      </buckminster>
	</target>


	<target name="step5">
		<antcall target="move_egf_to_tools"/>
	</target>

<target name="move_egf_to_tools">
	<delete dir="${tools}/egf"/>
	<move file="${publish}/egf" tofile="${tools}/egf" />
</target>


	<target name="step21">
		<antcall target="stats"/>
	</target>

<target name="stats">
	<property name="p2.site.path" value="${publish}/org.eclipse.egf.site/site.p2" />

	<unzip src="${p2.site.path}/artifacts.jar" dest="${p2.site.path}" />
	<delete file="${p2.site.path}/artifacts.jar" />
	<move file="${p2.site.path}/artifacts.xml" tofile="${p2.site.path}/artifacts.xml.orig" />

	<xslt style="${build.root}/svn/svn_eclipse/releng/org.eclipse.egf.releng2/ant/statsURI.xsl" 
		in="${p2.site.path}/artifacts.xml.orig" 
		out="${p2.site.path}/artifacts.xml">
		<param name="releaseName" expression="indigo"/>
	 </xslt>

	<zip destfile="${p2.site.path}/artifacts.jar" basedir="${p2.site.path}" includes="artifacts.xml" />
	<delete file="${p2.site.path}/artifacts.xml" />
	<delete file="${p2.site.path}/artifacts.xml.orig" />
</target>

	<target name="step22">
		<delete dir="${build.root}/../javadoc" />
		<javadoc
			destdir="${build.root}/../javadoc"
			maxmemory="1024m"
			source="1.5"
			useexternalfile="true"
			author="true"
			version="true"
			use="true"
			windowtitle="Javadoc">
 
		<link offline="false" href="http://download.oracle.com/javase/1.5.0/docs/api/"/> 
		<link offline="false" href="http://www.osgi.org/javadoc/r4v42/"/> 
		<link offline="false" href="http://download.eclipse.org/modeling/emf/emf/javadoc/2.5.0/"/> 
		<link offline="false" href="http://help.eclipse.org/galileo/index.jsp?topic=/org.eclipse.platform.doc.isv/reference/api/"/>

<!-- TODO better handling of dir parameter -->
<!-- TODO better handling of SourceBuildLocation model extension -->


		<fileset dir="${build.root}/svn/svn_eclipse/plugins" defaultexcludes="true">
 
			<include name="**/*.java"/>
		</fileset>

<!-- TODO better handling of copyright (escape chars) -->
<!-- <bottom>copyright</bottom> -->
	</javadoc>
</target>

	<target name="step9" depends="init,install.egf">
		<egf>
            <globargs>
				<jvmarg value="-Degf.target.bundle.priority=true" />            
			</globargs>
			<activities>
				<arg value="platform:/plugin/org.eclipse.egf.portfolio.eclipse.build/egf/Build.fcore#_gKQyUdBbEd-GApoE4u-xfw"/>
			</activities>
		</egf>
	</target>
	<target name="step13" depends="init,install.egf">
		<egf>
            <globargs>
				<jvmarg value="-Degf.target.bundle.priority=true" />
				<jvmarg value="-DfeatureName=org.eclipse.egf.examples-feature" />
				<jvmarg value="-DoutputFolder=${publish}/org.eclipse.egf.sdk/examples" />
				<jvmarg value="-DimporterName=org.eclipse.egf.examples.installer" />            
			</globargs>
			<activities>
				<arg value="platform:/plugin/org.eclipse.egf.releng2/egf/PublishExamples.fcore#_P2rGsKboEd-ZgeUI-BonwQ"/>
			</activities>
		</egf>
	</target>
	<target name="step15" depends="init,install.egf">
		<egf>
            <globargs>
				<jvmarg value="-Degf.target.bundle.priority=true" />
				<jvmarg value="-DfeatureName=org.eclipse.egf.portfolio.acceleo3.examples-feature" />
				<jvmarg value="-DoutputFolder=${publish}/org.eclipse.egf.portfolio.acceleo3/examples" />
				<jvmarg value="-DimporterName=org.eclipse.egf.portfolio.acceleo3.examples.installer" />            
			</globargs>
			<activities>
				<arg value="platform:/plugin/org.eclipse.egf.releng2/egf/PublishExamples.fcore#_P2rGsKboEd-ZgeUI-BonwQ"/>
			</activities>
		</egf>
	</target>
	<target name="step17" depends="init,install.egf">
		<egf>
            <globargs>
				<jvmarg value="-Degf.target.bundle.priority=true" />
				<jvmarg value="-DfeatureName=org.eclipse.egf.portfolio.atl.examples-feature" />
				<jvmarg value="-DoutputFolder=${publish}/org.eclipse.egf.portfolio.atl/examples" />
				<jvmarg value="-DimporterName=org.eclipse.egf.portfolio.atl.examples.installer" />            
			</globargs>
			<activities>
				<arg value="platform:/plugin/org.eclipse.egf.releng2/egf/PublishExamples.fcore#_P2rGsKboEd-ZgeUI-BonwQ"/>
			</activities>
		</egf>
	</target>
	<target name="step20" depends="init,install.egf" >
		<anteclipse target="step20_dropins" />
		<anteclipse target="step20_sitep2" />
	</target>	

	<target name="step20_dropins">
		<pathconvert property="aggregateDropinsFrom_org.eclipse.egf.sdk">
			<first count="1">
				<dirset dir="${build.root}/../../buckminster-egf-indigo/workspace/result/publish/org.eclipse.egf.sdk/dropins" includes="**/eclipse/" />
			</first>
		</pathconvert>
		<copy todir="${publish}/org.eclipse.egf.site/dropins/org.eclipse.egf.site/eclipse/" >
			<fileset dir="${aggregateDropinsFrom_org.eclipse.egf.sdk}"/>
		</copy>
		<pathconvert property="aggregateVersionFrom_org.eclipse.egf.sdk">
			<first count="1">
				<fileset dir="${build.root}/../../buckminster-egf-indigo/workspace/result/publish/org.eclipse.egf.sdk/dropins" includes="**/*_version_*" />
			</first>
		</pathconvert>
		<copy todir="${publish}/org.eclipse.egf.site/dropins/org.eclipse.egf.site/" >
			<fileset file="${aggregateVersionFrom_org.eclipse.egf.sdk}"/>
		</copy>
		<pathconvert property="aggregateDropinsFrom_org.eclipse.egf.portfolio.acceleo3">
			<first count="1">
				<dirset dir="${build.root}/../../buckminster-egf-indigo/workspace/result/publish/org.eclipse.egf.portfolio.acceleo3/dropins" includes="**/eclipse/" />
			</first>
		</pathconvert>
		<copy todir="${publish}/org.eclipse.egf.site/dropins/org.eclipse.egf.site/eclipse/" >
			<fileset dir="${aggregateDropinsFrom_org.eclipse.egf.portfolio.acceleo3}"/>
		</copy>
		<pathconvert property="aggregateVersionFrom_org.eclipse.egf.portfolio.acceleo3">
			<first count="1">
				<fileset dir="${build.root}/../../buckminster-egf-indigo/workspace/result/publish/org.eclipse.egf.portfolio.acceleo3/dropins" includes="**/*_version_*" />
			</first>
		</pathconvert>
		<copy todir="${publish}/org.eclipse.egf.site/dropins/org.eclipse.egf.site/" >
			<fileset file="${aggregateVersionFrom_org.eclipse.egf.portfolio.acceleo3}"/>
		</copy>
		<pathconvert property="aggregateDropinsFrom_org.eclipse.egf.portfolio.atl">
			<first count="1">
				<dirset dir="${build.root}/../../buckminster-egf-indigo/workspace/result/publish/org.eclipse.egf.portfolio.atl/dropins" includes="**/eclipse/" />
			</first>
		</pathconvert>
		<copy todir="${publish}/org.eclipse.egf.site/dropins/org.eclipse.egf.site/eclipse/" >
			<fileset dir="${aggregateDropinsFrom_org.eclipse.egf.portfolio.atl}"/>
		</copy>
		<pathconvert property="aggregateVersionFrom_org.eclipse.egf.portfolio.atl">
			<first count="1">
				<fileset dir="${build.root}/../../buckminster-egf-indigo/workspace/result/publish/org.eclipse.egf.portfolio.atl/dropins" includes="**/*_version_*" />
			</first>
		</pathconvert>
		<copy todir="${publish}/org.eclipse.egf.site/dropins/org.eclipse.egf.site/" >
			<fileset file="${aggregateVersionFrom_org.eclipse.egf.portfolio.atl}"/>
		</copy>
		<pathconvert property="aggregateDropinsFrom_org.eclipse.egf.portfolio.genchain.ecoretools">
			<first count="1">
				<dirset dir="${build.root}/../../buckminster-egf-indigo/workspace/result/publish/org.eclipse.egf.portfolio.genchain.ecoretools/dropins" includes="**/eclipse/" />
			</first>
		</pathconvert>
		<copy todir="${publish}/org.eclipse.egf.site/dropins/org.eclipse.egf.site/eclipse/" >
			<fileset dir="${aggregateDropinsFrom_org.eclipse.egf.portfolio.genchain.ecoretools}"/>
		</copy>
		<pathconvert property="aggregateVersionFrom_org.eclipse.egf.portfolio.genchain.ecoretools">
			<first count="1">
				<fileset dir="${build.root}/../../buckminster-egf-indigo/workspace/result/publish/org.eclipse.egf.portfolio.genchain.ecoretools/dropins" includes="**/*_version_*" />
			</first>
		</pathconvert>
		<copy todir="${publish}/org.eclipse.egf.site/dropins/org.eclipse.egf.site/" >
			<fileset file="${aggregateVersionFrom_org.eclipse.egf.portfolio.genchain.ecoretools}"/>
		</copy>
	</target>	

	<target name="step20_sitep2">
		<!-- see http://wiki.eclipse.org/Equinox/p2/Ant_Tasks -->
		<p2.mirror>
			<repository location="file:/${publish}/org.eclipse.egf.site/site.p2" name="buckminster-egf-indigo/org.eclipse.egf.site" />
			<source>
				<repository location="file:/${build.root}/../../buckminster-egf-indigo/workspace/result/publish/org.eclipse.egf.sdk/site.p2" />
				<repository location="file:/${build.root}/../../buckminster-egf-indigo/workspace/result/publish/org.eclipse.egf.portfolio.acceleo3/site.p2" />
				<repository location="file:/${build.root}/../../buckminster-egf-indigo/workspace/result/publish/org.eclipse.egf.portfolio.atl/site.p2" />
				<repository location="file:/${build.root}/../../buckminster-egf-indigo/workspace/result/publish/org.eclipse.egf.portfolio.genchain.ecoretools/site.p2" />
			</source>
		</p2.mirror>
	</target>
	<target name="step4" depends="init,install.director" >
        <eclipse.launch app="director">
            <args>
                <jvmarg value="-Declipse.p2.mirrors=false" />
                    <jvmarg value="-Xmx1024m"/>
                    <jvmarg value="-XX:MaxPermSize=256m"/>


            	<arg value="-roaming" />
            	<arg value="-profileProperties" />
                <arg value="org.eclipse.update.install.features=true " />

                <arg value="-d" />
                <arg value="${publish}/egf" />
                
                <arg value="-p" />
                <arg value="EGF" />

                <arg value="-r" />
                <arg value="http://download.eclipse.org/releases/indigo" />

                <arg value="-r" />
                <arg value="file:/${build.root}/../../buckminster-egf-indigo/workspace/result/publish/org.eclipse.egf/site.p2" />
                

                <arg value="-i" />
                <arg value="org.eclipse.platform.ide" />

                <arg value="-i" />
                <arg value="org.eclipse.egf.feature.group" />

            </args>
        </eclipse.launch>
	</target>	
</project>